---
# tasks file for php7

- stat: path={{ php_dir }}
  register: php

- stat: path="{{ src_dir }}/php-{{ php_version }}.tar.xz"
  register: php_source

- stat: path={{ src_dir }}/php-{{ php_version }}
  register: php_source_dir

- name: install dependencies
  yum: name={{ item }} state=present
  with_items: "{{ dependencies }}"
  
- name: download source
  get_url:
    url=http://php.net/get/php-{{ php_version }}.tar.xz/from/this/mirror
    dest={{ src_dir }}/php-{{ php_version }}.tar.xz
    sha256sum={{ src_sha256sum }}
  when: not php_source.stat.exists

- name: extract php source
  unarchive:
    src={{ src_dir }}/php-{{ php_version }}.tar.xz
    dest={{ src_dir }}
  when: not php_source_dir.stat.exists

- name: configure php
  command: >
    ./configure {{ configure_options | join(' ') }} chdir={{ src_dir }}/php-{{ php_version }}
  environment:
    CFLAGS: '-fstack-protector-strong -fpic -fpie -O2'
    CPPFLAGS: '-fstack-protector-strong -fpic -fpie -O2'
    LDFLAGS: '-Wl,-O1 -Wl,--hash-style=both -pie'
  when: not php.stat.exists
  
- name: build and install
  shell: make clean && make install chdir={{ src_dir }}/php-{{ php_version }}
  when: not php.stat.exists

- name: create config directories
  file: path=/usr/local/etc/php/conf.d state=directory owner=root group=root mode=0755
